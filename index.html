<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>心跳守護：血壓日誌</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="user-bar">
            <h1>心跳守護</h1>
            <div id="user-info" onclick="resetUser()">👤 載入中...</div>
        </div>
        <div class="date-stepper no-pdf">
            <button onclick="changeDate(-1)" class="btn-arrow-large">❮</button>
            <div id="target-date-display" class="today-tag">載入中...</div>
            <button onclick="changeDate(1)" class="btn-arrow-large">❯</button>
        </div>
    </header>

    <main class="container" id="main-report">
        <div class="card-grid no-pdf">
            <div id="morning-card" class="log-card morning" onclick="openModal('morning')">
                <div class="card-inline-content" style="pointer-events: none;">
                    <span class="icon-large">☀️</span>
                    <h2 class="text-large">早晨紀錄</h2>
                </div>
                <p id="morning-status" class="status-label" style="pointer-events: none;">尚未填寫</p>
            </div>
            <div id="evening-card" class="log-card evening" onclick="openModal('evening')">
                <div class="card-inline-content" style="pointer-events: none;">
                    <span class="icon-large">🌙</span>
                    <h2 class="text-large">晚間紀錄</h2>
                </div>
                <p id="evening-status" class="status-label" style="pointer-events: none;">尚未填寫</p>
            </div>
        </div>

        <section class="filter-section no-pdf">
            <div class="filter-buttons">
                <button onclick="handleRangeClick('today')" id="btn-today">本日</button>
                <button onclick="handleRangeClick('week')" id="btn-week" class="active">近一週</button>
                <button onclick="handleRangeClick('month')" id="btn-month">近一個月</button>
                <button onclick="handleRangeClick('custom')" id="btn-custom">自訂查詢</button>
            </div>
            <div id="custom-date-panel" class="custom-panel-fancy">
                <div class="panel-title">🗓️ 請選擇查詢區間</div>
                <div class="date-input-row-single">
                    <input type="date" id="start-date" class="compact-date-input">
                    <div class="date-arrow-single">➜</div>
                    <input type="date" id="end-date" class="compact-date-input">
                </div>
                <button class="btn-apply-fancy large-btn-text" onclick="applyCustomRange()">確認查詢</button>
            </div>
        </section>

        <section class="analysis-section">
            <div class="summary-card">
                <div class="summary-header">
                    <h3>📊 數據摘要</h3>
                    <span id="card-date-display" class="header-date"></span>
                </div>
                <p id="avg-text" class="avg-main-text">同步中...</p>
                <div id="health-tip" class="health-tip">
                    <div class="tip-title">💡 溫馨建議</div>
                    <div id="tip-content" class="tip-content">正在為您分析數據...</div>
                </div>
            </div>
            <div class="chart-container"><canvas id="bpChart"></canvas></div>
            <div class="action-buttons no-pdf">
                <button class="btn-pdf-large pdf-btn-style" onclick="exportPDF()">產出 PDF 報表</button>
                <button class="btn-share-large" onclick="shareToLine()">📤 分享至 LINE</button>
            </div>
        </section>

        <section class="history-section">
            <h3>📋 最近紀錄</h3>
            <div id="history-list"></div>
        </section>
    </main>

    <div id="login-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-icon">🧡</div>
            <h2 class="large-title">歡迎回來，守護您的健康</h2>
            <p class="warm-text">請告訴我您的專屬代號<br>我們將為您找回所有珍貴的紀錄</p>
            <input type="text" id="login-input" class="giant-input" placeholder="代號..." autocomplete="off">
            <button id="confirm-login-btn" class="btn-warm-save">開啟健康連線</button>
        </div>
    </div>

    <div id="log-modal" class="modal-overlay">
        <div class="modal-card">
            <h2 id="modal-title">紀錄數據</h2>
            <div class="input-container">
                <div class="input-block">
                    <label>收縮壓 (SYS)</label>
                    <input type="number" id="sys" inputmode="numeric" placeholder="請輸入數值">
                </div>
                <div class="input-block">
                    <label>舒張壓 (DIA)</label>
                    <input type="number" id="dia" inputmode="numeric" placeholder="請輸入數值">
                </div>
                <div class="input-block">
                    <label>心率 (PUL)</label>
                    <input type="number" id="pulse" inputmode="numeric" placeholder="請輸入數值">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-warm-save" onclick="saveData()">確認儲存</button>
                <button class="btn-text" onclick="closeModal()">取消</button>
            </div>
        </div>
    </div>

    <div style="position: absolute; left: -9999px; top: 0; width: 800px; text-align: center;">
        <div id="pdf-template" style="width: 720px; margin: 0 auto; background: white; padding: 10px 30px 30px 30px; font-family: 'Microsoft JhengHei', sans-serif; color: #000; text-align: center;">
            <h1 style="font-size: 34px; margin: 0 0 15px 0; color: #000; font-weight: 900; border-bottom: 5px solid #000; padding-bottom: 10px;">血壓記錄報表</h1>
            
            <p style="font-size: 20px; margin-bottom: 25px; font-weight: bold; text-align: center;">報告區間：<span id="pdf-range-display"></span></p>
            
            <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; table-layout: fixed; margin: 0 auto;">
                <thead>
                    <tr style="background: #f1f1f1; border-bottom: 2px solid #000;">
                        <th style="border: 2px solid #000; padding: 15px; font-size: 18px; width: 25%; text-align: center;">日期</th>
                        <th style="border: 2px solid #000; padding: 15px; font-size: 18px; width: 20%; text-align: center;">時段</th>
                        <th style="border: 2px solid #000; padding: 15px; font-size: 18px; width: 35%; text-align: center;">收縮壓 / 舒張壓</th>
                        <th style="border: 2px solid #000; padding: 15px; font-size: 18px; width: 20%; text-align: center;">心率</th>
                    </tr>
                </thead>
                <tbody id="pdf-table-body" style="font-size: 18px;"></tbody>
            </table>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>